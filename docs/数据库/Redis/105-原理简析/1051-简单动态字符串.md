# 简单动态字符串

### 概述

在redis数据库中，所有包含字符串的键值对在底层都是由SDS\(simple dynamic string)简单动态字符串实现的，不是C语言原生的以空字符('\0')结尾的字符数组。
好处：可以直接重用一部分C语言库的函数，而不用自己去写，比如：printf()

C字符串通常作为无需修改的字符串字面量。

```
redis> SET msg "Hello World"
```

在客户端执行上述命令时，redis会在数据库中创建一个新的键值对，其中：

* 键值对的键是一个字符串对象，对象的底层实现是保存着"msg"的SDS
* 键值对的值是一个字符串对象，对象的底层实现是一个保存着字符串"Hello World"的SDS。

```
redis> RPUSH drink "milk" "juice" "coffee"
```

上述命令的效果:

* 键值对的键是一个字符串对象，对象的底层实现是保存着"drink"的SDS
* 键值对的值是一个列表对象，对象的底层实现是由3个分别保存着对应字符串的SDS实现的

SDS定义： sds.h/sdshdr

```
struct sdshdr {
  int len; /* 记录buf数组当前字节长度，即SDS所保存的字符串长度,不算'\0' */
  int free; /* buf数组中未使用的字节数量 */
  char buf[]; /* 字节数组，存放字符串 */
}
```

### SDS的优势

* 常数复杂度获得字符串长度，C语言中的字符串需要遍历字符数组来获得长度，时间复杂度为O(n); SDS中可以直接获取len属性，时间复杂度O(1)

* 杜绝缓冲区溢出；buffer overflow问题同样是由于字符数组长度未知，导致不能分配足够多的内存空间，导致字符串溢出。而SDS的API在操作之前会先判断空间是否满足需要，不满足的话就会自动扩展。

* free属性实现空间预分配和惰性空间释放两种优化策略，避免字符串长度和底层数组长度之间的关联，字符数组中可以包含未使用的空间 。

  > 空间预分配: 空间预分配主要用于优化SDS的字符串增长操作。如果内存空间不够，sdsAPI不仅分配扩展空间，还会分配额外的未使用空间，减少连续执行字符串增长操作所需的内存重分配次数。具体的操作方式如下：
  
  > 1. 修改后SDS的len属性小于1MB时，分配和len属性值相同的未使用空间。总长度 = len + free + 1;
  > 2. 修改后SDS的len属性大于等于1MB时，分配1MB的未使用空间。
  
  > 惰性空间释放：主要用于优化SDS的字符串缩短操作。程序不是立即使用内存重分配来回收缩短后多出来的字节，而是使用free属性将这些字节数量记录，只有在真正需要的时候在进行系统调用释放内存。

* 二进制安全； SDS API会以处理二进制的方式来处理SDS存放在buf数组中的数据，不会做任何的操作，保证数据写入与读取的一致性，使用len属性来判断字符串的长度，而不是'\0'，因此可以用来存放二进制数据。







