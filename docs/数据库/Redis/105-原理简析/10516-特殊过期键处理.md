# 特殊过期键处理

### 概述

过期键对服务器中的其他模块有影响，比如RDB, AOF持久化以及主从复制。

### RDB持久化

**RDB文件的生成**在执行SAVE命令或者BGSAVE命令时创建一个新的RDB文件时，程序会对数据库中的键进行检查，过期的键不会被保存到新创建的RDB文件中。因此数据库中包含的过期键不会对新产生的RDB文件造成影响

**RDB文件的载入**在启动Redis服务器时，如果服务器开启了RDB功能，那么服务器将对RDB文件进行载入：

* 如果服务器以主服务器模式master运行，那么在载入RDB文件时，程序会对文件中保存的键进行检查，未过期的键会载入到数据库中，过期键将会被忽略。
* 服务器以从服务器模式slave运行，那么在载入RDB文件时，文件中保存的所有键，不论是否过期，都会被载入到数据库中，不过，因为主从服务器在进行数据同步的时候，从服务器的数据库就会被
  **清空**
  ，所以过期键对载入RDB文件的从服务器也不会造成影响。

### AOF持久化

**AOF文件写入**当服务器以AOF持久化模式运行时，如果数据库中的某个键已经过期，但他还没有被惰性删除或者定期删除，那么AOF文件不会因为这个过期键产生任何影响。AOF正常写入命令。

当过期键被惰性删除或者定期删除后，程序会向AOF文件追加\(append\)一条DEL命令，来显式地记录该键已被删除。

**AOF重写**在执行AOF重写的过程中，程序会对数据库中的键进行检查，已过期的键不会被保存到重写后的AOF文件中。

### 复制

当服务器运行在赋值模式下时，从服务器的过期键删除动作由主服务器控制

* 主服务器在删除一个过期键后，显式地向所有从服务器发送一个DEL命令，告知从服务器删除这个过期键。
* 从服务器在执行客户端发送的读命令时，即使碰到过期键也不会将过期键删除，而是继续麻木不仁
* 从服务器在接收到主服务器的删除命令时，删除掉过期键

我称之为**从服务器被动删除**保证主从服务器数据一致性

### 数据库通知

客户端通过订阅给定的频道或者模式，来获知数据库中间的变化，以及数据库中命令的执行情况。 SUBSCRIBE**keyspace@0**:key 关注某个键执行了什么命令，称为键空间通知 key-space notification，除此之外还有一类称为键事件通知，关注的是哪个命令被执行了 SUBSCRIBE**keyevent@0**:cmd

发送通知 ： 数据库通知的功能是由notify.c/notifyKeyspaceEvent 函数实现的

```
void notifyKeyspaceEvent(int type, char *event, robj *key, int dbid)
```

函数的type参数是当前想要发送的通知类型，程序会根据这个值来判断通知是否就是服务器配置的`notify-keyspace-events`类型，决定是否发送通知。 event、keys和dbid分别表示事件的名称、产生事件的键，以及产生事件的数据库号码，函数会根据type参数以及这三个参数来构建事件通知的内容，以及接受通知的频道名。+

每当一个Redis命令需要发送数据库通知的时候，就会调用这个函数，并向函数传递该命令所引发的事件的相关信息。command函数中有对应的函数，当命令成功执行后就会发送时间通知

